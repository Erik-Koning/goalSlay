generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
}

// ============================================
// BETTER-AUTH MODELS (existing)
// ============================================

model account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?
}

// ============================================
// USER MODEL (extended for GoalSlay)
// ============================================

model user {
  id            String   @id
  email         String   @unique @db.VarChar(255)
  name          String   @db.VarChar(255)
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime

  // Role: "user" | "admin"
  role     String @default("user") @db.VarChar(50)
  timezone String @default("UTC") @db.VarChar(100)

  // Gamification - streak tracking
  streakCurrent    Int       @default(0) @map("streak_current")
  streakLongest    Int       @default(0) @map("streak_longest")
  streakLastUpdate DateTime? @map("streak_last_update")
  totalPoints      Int       @default(0) @map("total_points")

  // Better-Auth relations
  account account[]
  session session[]

  // GoalSlay relations
  createdGuides       GoalGuide[]          @relation("GuideCreator")
  assignedGuides      GoalGuide[]          @relation("GuideAssignee")
  goalSets            UserGoalSet[]        @relation("GoalSetOwner")
  approvedGoalSets    UserGoalSet[]        @relation("GoalSetApprover")
  modifiedEstimates   GoalProgressEstimate[] @relation("EstimateModifier")
  dailyUpdates        DailyUpdate[]
  extractedActivities ExtractedActivity[]
  userAchievements    UserAchievement[]
  notificationSettings NotificationSettings?
  adminSettings       AdminSettings[]

  @@map("users")
}

// ============================================
// GOAL GUIDES (admin-created guidelines)
// ============================================

model GoalGuide {
  id          String  @id @default(cuid())
  createdById String? @map("created_by")
  title       String  @db.VarChar(255)
  description String? @db.Text

  // GuideType: "role_guide" | "goal_guide"
  guideType String @map("guide_type") @db.VarChar(50)
  content   String @db.Text // JSON: Rules, examples, constraints

  isDefault       Boolean @default(false) @map("is_default")
  isActive        Boolean @default(true) @map("is_active")
  appliesToUserId String? @map("applies_to_user_id") // NULL = applies to all

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy user? @relation("GuideCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  appliesTo user? @relation("GuideAssignee", fields: [appliesToUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("goal_guides")
}

// ============================================
// USER GOAL SET (container for 3-5 goals)
// ============================================

model UserGoalSet {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // Status: "draft" | "pending_review" | "pending_approval" | "active" | "completed" | "abandoned"
  status           String    @default("draft") @db.VarChar(50)
  startDate        DateTime  @map("start_date") @db.Date
  endDate          DateTime? @map("end_date") @db.Date
  requiresApproval Boolean   @default(false) @map("requires_approval")
  approvedById     String?   @map("approved_by")
  approvedAt       DateTime? @map("approved_at")
  adminComment     String?   @map("admin_comment") @db.Text
  editableUntil    DateTime? @map("editable_until") @db.Date // start_date + 14 days

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         user          @relation("GoalSetOwner", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  approvedBy   user?         @relation("GoalSetApprover", fields: [approvedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  goals        Goal[]
  dailyUpdates DailyUpdate[]

  @@index([userId])
  @@index([status])
  @@map("user_goal_sets")
}

// ============================================
// GOAL (individual goal within a set)
// ============================================

model Goal {
  id            String @id @default(cuid())
  userGoalSetId String @map("user_goal_set_id")
  goalText      String @map("goal_text") @db.Text
  goalOrder     Int    @map("goal_order") // 1-5

  // ValidationStatus: "pending" | "valid" | "warning" | "rejected"
  validationStatus   String  @default("pending") @map("validation_status") @db.VarChar(50)
  validationFeedback String? @map("validation_feedback") @db.Text
  expertSummary      String? @map("expert_summary") @db.Text // Orchestrator's aggregated summary

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userGoalSet       UserGoalSet            @relation(fields: [userGoalSetId], references: [id], onDelete: Cascade)
  progressEstimates GoalProgressEstimate[]
  expertReviews     ExpertReview[]
  expertSelections  GoalExpertSelection[]
  linkedActivities  ExtractedActivity[]

  @@index([userGoalSetId])
  @@map("goals")
}

// ============================================
// GOAL PROGRESS ESTIMATE (from Progress Tracker expert)
// ============================================

model GoalProgressEstimate {
  id               String   @id @default(cuid())
  goalId           String   @map("goal_id")
  unit             String   @db.VarChar(100) // e.g., 'experiments', 'hours', 'demos'
  estimatedPerDay  Decimal  @map("estimated_per_day") @db.Decimal(10, 2)
  estimatedPerWeek Decimal  @map("estimated_per_week") @db.Decimal(10, 2)

  // SetBy: "expert" | "user" | "admin"
  setBy        String    @default("expert") @map("set_by") @db.VarChar(50)
  modifiedById String?   @map("modified_by")
  modifiedAt   DateTime? @map("modified_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  goal       Goal  @relation(fields: [goalId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  modifiedBy user? @relation("EstimateModifier", fields: [modifiedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("goal_progress_estimates")
}

// ============================================
// EXPERT REVIEW (individual expert's feedback)
// ============================================

model ExpertReview {
  id            String @id @default(cuid())
  goalId        String @map("goal_id")
  expertId      String @map("expert_id") @db.VarChar(50) // e.g., 'progress_tracker'
  expertName    String @map("expert_name") @db.VarChar(100)
  reviewContent String @map("review_content") @db.Text
  actionItems   String? @map("action_items") @db.Text // JSON array of suggested actions

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@map("expert_reviews")
}

// ============================================
// GOAL EXPERT SELECTION (which experts user chose)
// ============================================

model GoalExpertSelection {
  id         String  @id @default(cuid())
  goalId     String  @map("goal_id")
  expertId   String  @map("expert_id") @db.VarChar(50)
  isRequired Boolean @default(false) @map("is_required") // progress_tracker is always required

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, expertId])
  @@map("goal_expert_selections")
}

// ============================================
// DAILY UPDATE (user check-ins)
// ============================================

model DailyUpdate {
  id            String @id @default(cuid())
  userId        String @map("user_id")
  userGoalSetId String @map("user_goal_set_id")
  updateText    String @map("update_text") @db.Text

  // UpdatePeriod: "morning" | "afternoon" | "evening" | "full_day"
  updatePeriod String   @map("update_period") @db.VarChar(50)
  periodDate   DateTime @map("period_date") @db.Date

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user                user                @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userGoalSet         UserGoalSet         @relation(fields: [userGoalSetId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  extractedActivities ExtractedActivity[]

  @@index([userId, periodDate])
  @@map("daily_updates")
}

// ============================================
// EXTRACTED ACTIVITY (LLM-parsed from daily updates)
// ============================================

model ExtractedActivity {
  id            String @id @default(cuid())
  dailyUpdateId String @map("daily_update_id")
  userId        String @map("user_id")

  // ActivityType: "experiments" | "product_demos" | "mentoring" | "presentations" | "volunteering"
  activityType String   @map("activity_type") @db.VarChar(50)
  quantity     Decimal  @db.Decimal(10, 2)
  summary      String   @db.Text
  activityDate DateTime @map("activity_date") @db.Date

  // Period: "morning" | "afternoon" | "evening" | "full_day"
  period       String  @db.VarChar(50)
  linkedGoalId String? @map("linked_goal_id") // Optional link to specific goal

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  dailyUpdate DailyUpdate @relation(fields: [dailyUpdateId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user        user        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  linkedGoal  Goal?       @relation(fields: [linkedGoalId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([userId, activityDate])
  @@index([activityType])
  @@map("extracted_activities")
}

// ============================================
// ACHIEVEMENT (system-defined badges)
// ============================================

model Achievement {
  id          String @id @default(cuid())
  name        String @unique @db.VarChar(100)
  description String @db.Text
  icon        String @db.VarChar(100) // Icon identifier

  // AchievementCategory: "streak" | "goals" | "activities" | "special"
  category String @db.VarChar(50)
  points   Int    @default(0)
  criteria String @db.Text // JSON: Conditions to unlock
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

// ============================================
// USER ACHIEVEMENT (earned badges)
// ============================================

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  earnedAt      DateTime @default(now()) @map("earned_at")

  // Relations
  user        user        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

// ============================================
// NOTIFICATION SETTINGS (per-user preferences)
// ============================================

model NotificationSettings {
  id                       String  @id @default(cuid())
  userId                   String  @unique @map("user_id")
  progressReminderEnabled  Boolean @default(true) @map("progress_reminder_enabled")
  progressThresholdPercent Int     @default(50) @map("progress_threshold_percent")
  dailyReminderEnabled     Boolean @default(true) @map("daily_reminder_enabled")
  dailyReminderTime        String  @default("09:00") @map("daily_reminder_time") @db.VarChar(5)
  weeklySummaryEnabled     Boolean @default(true) @map("weekly_summary_enabled")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user user @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

// ============================================
// ADMIN SETTINGS (key-value store)
// ============================================

model AdminSettings {
  id           String @id @default(cuid())
  adminId      String @map("admin_id")
  settingKey   String @map("setting_key") @db.VarChar(100)
  settingValue String @map("setting_value") @db.Text // JSON value

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  admin user @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, settingKey])
  @@map("admin_settings")
}
